<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bitcamp.acv.dao.FollowDao">

 <resultMap type="follow" id="FollowMap">
  <id column="fno"            property="no" />
  <result column="target"     property="followedNo" />
  <result column="fano"  property="followedType"/>
  <result column="fdt"        property="followedDate"/>
  <result column="stat"        property="status"/>

  <association property="followingMember" javaType="Member">
    <id column="mno" property="no"/>
    <result column="nick" property="nickName"/>
    <result column="email" property="email"/>
  </association>
 </resultMap>

  <sql id="sql1">
  select
    f.fno,
    f.target,
    f.fdt,
    f.stat,
    mb.mno mno,
    mb.nick nick,
    fa.fano,
    fa.name fano_name
  from
    acv_flw f
    inner join acv_mbr mb on f.flwing_mbr=mb.mno
    inner join acv_flw_able fa on f.fano = fa.fano
  </sql> 

 <!-- 팔로우 타겟 상세 -->
 <select id="findByNo" resultMap="FollowMap" parameterType="int">
    <include refid="sql1"/>
    where
      f.fno=#{fno} 
  </select>
  
   <!-- 멤버 팔로우 리스트
 <select id="findByFollowingUsers" resultMap="FollowMap2">
  <include refid="sql2"/>
  where f.flwing_mbr=#{mno} and f.fano = 1 and f.stat = 1
  order by
    mb.nick desc
  </select>
   -->
 
 <!-- 팔로우 리스트 -->
 <select id="findAll" resultMap="FollowMap">
  <include refid="sql1"/>
  order by
    mb.nick desc
  </select>
   
 <!-- 팔로잉 유저 insert -->
  <insert id="insertUser" parameterType="follow">
  insert into acv_flw(flwing_mbr, target, fano)
  values(#{followingMember.no},#{followedNo}, 1)
 </insert>
 
  <!-- 팔로잉 태그 insert -->
  <insert id="insertTag" parameterType="follow">
  insert into acv_flw(flwing_mbr, target, fano)
  values(#{followingMember.no},#{followedNo}, 2)
 </insert>
 
  <update id="deleteUser" parameterType="follow">
   delete from acv_flw
    where flwing_mbr=#{followingMember.no} and fano=1 and target=#{followedNo}
  </update>
  
  <update id="deleteTag" parameterType="follow">
   delete from acv_flw
    where flwing_mbr=#{followingMember.no} and fano=2 and target=#{followedNo}
    </update>
    
  <!-- 팔로우 상태 변경 -->
  <!-- 1. 팔로우 상태 -->
   <update id="active" parameterType="int">
    update acv_flw set
     stat = 1
    where flwing_mbr=#{followingMember.no} and target=#{followedNo}
  </update>
  
    <!-- 2. 언팔로우 상태 -->
  <update id="inactive" parameterType="int">
  update acv_flw set
    stat = 2
  where flwing_mbr=#{followingMember.no} and target=#{followedNo}
  </update>
  
   <!-- 언팔로우(delete) 태그, 언팔로우(delete) 유저
  <select id="findByFollowList" resultMap="FollowMap2" parameterType="int">
  <include refid="sql1"/>
  where
    mb.mno=#{followingMember} and stat={status}
  order by
    f.fno desc
  </select>
 
 <select id="findByFollowMembers" parameterType="map" resultMap="MemberMap3">
   select
    count(*)
    from acv_mbr mb
     inner join acv_flw f on f.flwing_mbr= mb.mno
     inner join acv_flw_able fa on f.fano = fa.fano
     right join acv_mbr mb2 on f.target=mb2.mno
    where f.flwing_mbr=#{mno} and f.fano = 1 and f.target={followedNo}
  </select>

   -->

</mapper>